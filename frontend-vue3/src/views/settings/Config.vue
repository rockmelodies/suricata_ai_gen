<template>
  <div class="config-container">
    <el-card>
      <template #header>
        <div class="card-header">
          <span>âš™ï¸ ç³»ç»Ÿé…ç½®</span>
        </div>
      </template>

      <el-form
        ref="formRef"
        :model="config"
        :rules="rules"
        label-width="auto"
        size="large"
        :label-position="labelPosition"
      >
        <el-form-item label="é»˜è®¤PCAPè·¯å¾„" prop="default_pcap_path">
          <el-input
            v-model="config.default_pcap_path"
            placeholder="è¯·è¾“å…¥PCAPæ–‡ä»¶æ‰€åœ¨ç›®å½•è·¯å¾„"
            @blur="saveConfig"
          >
            <template #prepend>
              <el-icon><FolderOpened /></el-icon>
            </template>
            <template #append>
              <el-button type="primary" @click="saveConfig" plain>ä¿å­˜</el-button>
            </template>
          </el-input>
          <div class="form-tip">
            <el-icon><InfoFilled /></el-icon>
            é»˜è®¤ç”¨äºè§„åˆ™éªŒè¯çš„PCAPæ–‡ä»¶ç›®å½•è·¯å¾„
          </div>
        </el-form-item>

        <el-form-item label="ä¸Šä¼ ç›®å½•" prop="upload_dir">
          <el-input
            v-model="config.upload_dir"
            placeholder="è¯·è¾“å…¥ä¸Šä¼ æ–‡ä»¶ä¿å­˜ç›®å½•"
            @blur="saveConfig"
          >
            <template #prepend>
              <el-icon><Upload /></el-icon>
            </template>
            <template #append>
              <el-button type="primary" @click="saveConfig" plain>ä¿å­˜</el-button>
            </template>
          </el-input>
          <div class="form-tip">
            <el-icon><InfoFilled /></el-icon>
            ä¸Šä¼ çš„PCAPæ–‡ä»¶ä¿å­˜ç›®å½•ï¼Œé»˜è®¤ä¸º 'uploads'
          </div>
        </el-form-item>

        <el-divider />

        <h3>ğŸ”§ Suricataé…ç½®</h3>

        <el-form-item label="è§„åˆ™ç›®å½•" prop="suricata_rules_dir">
          <el-input
            v-model="config.suricata_rules_dir"
            placeholder="è¯·è¾“å…¥Suricataè§„åˆ™ç›®å½•è·¯å¾„"
            @blur="saveConfig"
          >
            <template #prepend>
              <el-icon><Folder /></el-icon>
            </template>
            <template #append>
              <el-button type="primary" @click="saveConfig" plain>ä¿å­˜</el-button>
            </template>
          </el-input>
          <div class="form-tip">
            <el-icon><InfoFilled /></el-icon>
            Suricataè§„åˆ™æ–‡ä»¶å­˜æ”¾ç›®å½•
          </div>
        </el-form-item>

        <el-form-item label="é…ç½®æ–‡ä»¶" prop="suricata_config">
          <el-input
            v-model="config.suricata_config"
            placeholder="è¯·è¾“å…¥Suricataé…ç½®æ–‡ä»¶è·¯å¾„"
            @blur="saveConfig"
          >
            <template #prepend>
              <el-icon><Document /></el-icon>
            </template>
            <template #append>
              <el-button type="primary" @click="saveConfig" plain>ä¿å­˜</el-button>
            </template>
          </el-input>
          <div class="form-tip">
            <el-icon><InfoFilled /></el-icon>
            Suricataé…ç½®æ–‡ä»¶è·¯å¾„
          </div>
        </el-form-item>

        <el-form-item label="æ—¥å¿—ç›®å½•" prop="suricata_log_dir">
          <el-input
            v-model="config.suricata_log_dir"
            placeholder="è¯·è¾“å…¥Suricataæ—¥å¿—ç›®å½•è·¯å¾„"
            @blur="saveConfig"
          >
            <template #prepend>
              <el-icon><FolderOpened /></el-icon>
            </template>
            <template #append>
              <el-button type="primary" @click="saveConfig" plain>ä¿å­˜</el-button>
            </template>
          </el-input>
          <div class="form-tip">
            <el-icon><InfoFilled /></el-icon>
            Suricataæ—¥å¿—æ–‡ä»¶å­˜æ”¾ç›®å½•
          </div>
        </el-form-item>

        <el-form-item label="PCAPç›®å½•" prop="pcap_dir">
          <el-input
            v-model="config.pcap_dir"
            placeholder="è¯·è¾“å…¥PCAPæ–‡ä»¶ç›®å½•è·¯å¾„"
            @blur="saveConfig"
          >
            <template #prepend>
              <el-icon><Folder /></el-icon>
            </template>
            <template #append>
              <el-button type="primary" @click="saveConfig" plain>ä¿å­˜</el-button>
            </template>
          </el-input>
          <div class="form-tip">
            <el-icon><InfoFilled /></el-icon>
            PCAPæ–‡ä»¶å­˜æ”¾ç›®å½•
          </div>
        </el-form-item>

        <el-divider />

        <h3>ğŸ”— SSHè¿œç¨‹éªŒè¯é…ç½®</h3>

        <el-form-item label="SSHä¸»æœº" prop="ssh_host">
          <el-input
            v-model="config.ssh_host"
            placeholder="è¯·è¾“å…¥SSHä¸»æœºåœ°å€ï¼Œå¦‚ï¼š192.168.1.100"
            @blur="saveConfig"
          >
            <template #prepend>
              <el-icon><Connection /></el-icon>
            </template>
            <template #append>
              <el-button type="primary" @click="saveConfig" plain>ä¿å­˜</el-button>
            </template>
          </el-input>
          <div class="form-tip">
            <el-icon><InfoFilled /></el-icon>
            ç”¨äºè¿œç¨‹éªŒè¯çš„SSHä¸»æœºåœ°å€
          </div>
        </el-form-item>

        <el-form-item label="SSHç”¨æˆ·" prop="ssh_user">
          <el-input
            v-model="config.ssh_user"
            placeholder="è¯·è¾“å…¥SSHç”¨æˆ·åï¼Œå¦‚ï¼škali"
            @blur="saveConfig"
          >
            <template #prepend>
              <el-icon><User /></el-icon>
            </template>
            <template #append>
              <el-button type="primary" @click="saveConfig" plain>ä¿å­˜</el-button>
            </template>
          </el-input>
          <div class="form-tip">
            <el-icon><InfoFilled /></el-icon>
            ç”¨äºè¿œç¨‹éªŒè¯çš„SSHç”¨æˆ·å
          </div>
        </el-form-item>

        <el-form-item label="SSHå¯†é’¥è·¯å¾„" prop="ssh_key">
          <el-input
            v-model="config.ssh_key"
            placeholder="è¯·è¾“å…¥SSHç§é’¥æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰"
            @blur="saveConfig"
          >
            <template #prepend>
              <el-icon><Lock /></el-icon>
            </template>
            <template #append>
              <el-button type="primary" @click="saveConfig" plain>ä¿å­˜</el-button>
            </template>
          </el-input>
          <div class="form-tip">
            <el-icon><InfoFilled /></el-icon>
            SSHç§é’¥æ–‡ä»¶è·¯å¾„ï¼Œç•™ç©ºåˆ™ä½¿ç”¨å¯†ç è®¤è¯
          </div>
        </el-form-item>

        <el-form-item>
          <el-button
            type="primary"
            @click="saveConfig"
          >
            <el-icon><Check /></el-icon>
            ä¿å­˜æ‰€æœ‰é…ç½®
          </el-button>
          <el-button @click="resetConfig">é‡ç½®</el-button>
        </el-form-item>
      </el-form>

      <el-divider />

      <div class="config-info">
        <h3>ğŸ“‹ é…ç½®ä¿¡æ¯</h3>
        <el-descriptions :column="1" border>
          <el-descriptions-item label="å½“å‰é»˜è®¤PCAPè·¯å¾„">
            {{ config.default_pcap_path }}
          </el-descriptions-item>
          <el-descriptions-item label="ä¸Šä¼ ç›®å½•">
            {{ config.upload_dir }}
          </el-descriptions-item>
          <el-descriptions-item label="é…ç½®æ–‡ä»¶è·¯å¾„">
            {{ config.config_file_path }}
          </el-descriptions-item>
          <el-descriptions-item label="Suricataè§„åˆ™ç›®å½•">
            {{ config.suricata_rules_dir }}
          </el-descriptions-item>
          <el-descriptions-item label="Suricataé…ç½®æ–‡ä»¶">
            {{ config.suricata_config }}
          </el-descriptions-item>
          <el-descriptions-item label="Suricataæ—¥å¿—ç›®å½•">
            {{ config.suricata_log_dir }}
          </el-descriptions-item>
          <el-descriptions-item label="PCAPç›®å½•">
            {{ config.pcap_dir }}
          </el-descriptions-item>
          <el-descriptions-item label="SSHä¸»æœº">
            {{ config.ssh_host || 'æœªé…ç½®' }}
          </el-descriptions-item>
          <el-descriptions-item label="SSHç”¨æˆ·">
            {{ config.ssh_user || 'æœªé…ç½®' }}
          </el-descriptions-item>
          <el-descriptions-item label="SSHå¯†é’¥è·¯å¾„">
            {{ config.ssh_key || 'æœªé…ç½®' }}
          </el-descriptions-item>
        </el-descriptions>
      </div>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted, onUnmounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  Check,
  FolderOpened,
  InfoFilled,
  Upload,
  Folder,
  Document,
  Connection,
  User,
  Lock
} from '@element-plus/icons-vue'
import type { FormInstance, FormRules } from 'element-plus'
import { getPCAPConfig, setPCAPConfig } from '@/api/rules'

const formRef = ref<FormInstance>()
const labelPosition = ref<'left' | 'top'>('left')

// é…ç½®æ•°æ®
const config = reactive({
  default_pcap_path: '/home/kali/pcap_check',
  upload_dir: 'uploads',
  config_file_path: 'pcap_config.json',
  suricata_rules_dir: 'C:\\Program Files\\Suricata\\rules',
  suricata_config: 'C:\\Program Files\\Suricata\\suricata.yaml',
  suricata_log_dir: 'C:\\Program Files\\Suricata\\log',
  pcap_dir: 'C:\\pcap_check',
  ssh_host: '',
  ssh_user: '',
  ssh_key: ''
})

// è¡¨å•éªŒè¯è§„åˆ™
const rules: FormRules = {
  default_pcap_path: [
    { required: true, message: 'è¯·è¾“å…¥é»˜è®¤PCAPè·¯å¾„', trigger: 'blur' }
  ],
  upload_dir: [
    { required: true, message: 'è¯·è¾“å…¥ä¸Šä¼ ç›®å½•', trigger: 'blur' }
  ],
  suricata_rules_dir: [
    { required: true, message: 'è¯·è¾“å…¥Suricataè§„åˆ™ç›®å½•', trigger: 'blur' }
  ],
  suricata_config: [
    { required: true, message: 'è¯·è¾“å…¥Suricataé…ç½®æ–‡ä»¶è·¯å¾„', trigger: 'blur' }
  ],
  suricata_log_dir: [
    { required: true, message: 'è¯·è¾“å…¥Suricataæ—¥å¿—ç›®å½•', trigger: 'blur' }
  ],
  pcap_dir: [
    { required: true, message: 'è¯·è¾“å…¥PCAPç›®å½•', trigger: 'blur' }
  ],
  ssh_host: [
    { message: 'è¯·è¾“å…¥SSHä¸»æœºåœ°å€', trigger: 'blur' }
  ],
  ssh_user: [
    { message: 'è¯·è¾“å…¥SSHç”¨æˆ·å', trigger: 'blur' }
  ]
}

// å“åº”å¼å¤„ç†
const handleResize = () => {
  if (window.innerWidth < 768) {
    labelPosition.value = 'top'
  } else {
    labelPosition.value = 'left'
  }
}

onMounted(() => {
  handleResize()
  window.addEventListener('resize', handleResize)
  loadConfig()
})

onUnmounted(() => {
  window.removeEventListener('resize', handleResize)
})

// åŠ è½½é…ç½®
const loadConfig = async () => {
  try {
    const res: any = await getPCAPConfig()
    if (res.success) {
      config.default_pcap_path = res.config.default_pcap_path
      config.upload_dir = res.config.upload_dir
      config.config_file_path = res.config.config_file_path
      config.suricata_rules_dir = res.config.suricata_rules_dir
      config.suricata_config = res.config.suricata_config
      config.suricata_log_dir = res.config.suricata_log_dir
      config.pcap_dir = res.config.pcap_dir
      config.ssh_host = res.config.ssh_host || ''
      config.ssh_user = res.config.ssh_user || ''
      config.ssh_key = res.config.ssh_key || ''
    }
  } catch (error) {
    console.error('åŠ è½½é…ç½®å¤±è´¥:', error)
    ElMessage.error('åŠ è½½é…ç½®å¤±è´¥')
  }
}

// ä¿å­˜é…ç½®
const saveConfig = async () => {
  if (!formRef.value) return
  
  await formRef.value.validate(async (valid) => {
    if (valid) {
      try {
        const res: any = await setPCAPConfig({ 
          default_pcap_path: config.default_pcap_path,
          upload_dir: config.upload_dir,
          suricata_rules_dir: config.suricata_rules_dir,
          suricata_config: config.suricata_config,
          suricata_log_dir: config.suricata_log_dir,
          pcap_dir: config.pcap_dir,
          ssh_host: config.ssh_host,
          ssh_user: config.ssh_user,
          ssh_key: config.ssh_key
        })
        if (res.success) {
          ElMessage.success(res.message)
        } else {
          ElMessage.error(res.message)
        }
      } catch (error: any) {
        ElMessage.error(error.response?.data?.error || 'ä¿å­˜é…ç½®å¤±è´¥')
      }
    }
  })
}

// é‡ç½®é…ç½®
const resetConfig = () => {
  ElMessageBox.confirm(
    'ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
    'ç¡®è®¤é‡ç½®',
    {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    }
  ).then(() => {
    config.default_pcap_path = '/home/kali/pcap_check'
    config.upload_dir = 'uploads'
    config.config_file_path = 'pcap_config.json'
    config.suricata_rules_dir = 'C:\\Program Files\\Suricata\\rules'
    config.suricata_config = 'C:\\Program Files\\Suricata\\suricata.yaml'
    config.suricata_log_dir = 'C:\\Program Files\\Suricata\\log'
    config.pcap_dir = 'C:\\pcap_check'
    config.ssh_host = ''
    config.ssh_user = ''
    config.ssh_key = ''
    ElMessage.success('é…ç½®å·²é‡ç½®')
  }).catch(() => {
    // ç”¨æˆ·å–æ¶ˆæ“ä½œ
  })
}
</script>

<style scoped>
.config-container {
  max-width: 1200px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 16px;
  font-weight: 500;
}

.form-tip {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 4px;
  font-size: 12px;
  color: #909399;
}

.config-info {
  margin-top: 30px;
}

.config-info h3 {
  margin-bottom: 16px;
  font-size: 16px;
  font-weight: 500;
}

@media (max-width: 768px) {
  .card-header {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
  
  .el-form-item__content {
    flex-wrap: wrap;
  }
}
</style>